<div class="perfil-container">
    <div class="container-modern animate-fade-in">

        <!-- Loading indicator -->
        <div *ngIf="isLoading()" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Cargando perfil...</p>
        </div>

        <!-- Contenido del perfil -->
        <div *ngIf="!isLoading() && perfilAlumno()">

            <!-- Header del perfil usando componente compartido -->
            <app-profile-header [data]="profileHeaderData()!" [socialLinks]="socialLinksCompact()"
                [isEditing]="isEditing" [imagePreview]="imagePreview" (editProfile)="onEditProfile()"
                (saveChanges)="onSaveChanges()" (cancelEdit)="onCancelEdit()" (downloadCV)="onDownloadCV()"
                (imageSelected)="onImageSelected($event)">
            </app-profile-header>

            <!-- Formulario de edición -->
            <div *ngIf="isEditing()" class="edit-form-container">
                <mat-card class="modern-card edit-form">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">edit</mat-icon>
                            Editar Información Personal
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <form [formGroup]="editForm" class="edit-form-grid">
                            <!-- Información Personal -->
                            <h3 class="form-section-title">Información Personal</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Nombre</mat-label>
                                    <input matInput formControlName="name" required>
                                    <mat-error *ngIf="f['name'].invalid && f['name'].touched">
                                        El nombre es requerido y debe tener al menos 2 caracteres
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Apellido</mat-label>
                                    <input matInput formControlName="surname" required>
                                    <mat-error *ngIf="f['surname'].invalid && f['surname'].touched">
                                        El apellido es requerido y debe tener al menos 2 caracteres
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Email</mat-label>
                                    <input matInput formControlName="email" type="email" required>
                                    <mat-error *ngIf="f['email'].invalid && f['email'].touched">
                                        Ingrese un email válido
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Teléfono</mat-label>
                                    <input matInput formControlName="phone" required>
                                    <mat-error *ngIf="f['phone'].invalid && f['phone'].touched">
                                        El teléfono es requerido
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Ubicación</mat-label>
                                    <input matInput formControlName="location" required>
                                    <mat-error *ngIf="f['location'].invalid && f['location'].touched">
                                        La ubicación es requerida
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Fecha de Nacimiento</mat-label>
                                    <input matInput type="date" formControlName="dateOfBirth" required>
                                    <mat-error *ngIf="f['dateOfBirth'].invalid && f['dateOfBirth'].touched">
                                        La fecha de nacimiento es requerida
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>Descripción</mat-label>
                                <textarea matInput formControlName="description" rows="4" maxlength="500"></textarea>
                                <mat-hint>{{f['description'].value?.length || 0}}/500</mat-hint>
                                <mat-error *ngIf="f['description'].invalid && f['description'].touched">
                                    La descripción no puede exceder 500 caracteres
                                </mat-error>
                            </mat-form-field>

                            <!-- Información Académica -->
                            <h3 class="form-section-title">Información Académica</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Carrera</mat-label>
                                    <input matInput formControlName="career" required>
                                    <mat-error *ngIf="f['career'].invalid && f['career'].touched">
                                        La carrera es requerida
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Año</mat-label>
                                    <mat-select formControlName="currentYearLevel" required>
                                        <mat-option value="1">1er año</mat-option>
                                        <mat-option value="2">2do año</mat-option>
                                        <mat-option value="3">3er año</mat-option>
                                        <mat-option value="4">4to año</mat-option>
                                        <mat-option value="5">5to año</mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="f['currentYearLevel'].invalid && f['currentYearLevel'].touched">
                                        El año es requerido
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>Institución</mat-label>
                                <input matInput formControlName="institution" required>
                                <mat-error *ngIf="f['institution'].invalid && f['institution'].touched">
                                    La institución es requerida
                                </mat-error>
                            </mat-form-field>

                            <!-- Habilidades -->
                            <h3 class="form-section-title">Skills/Habilidades</h3>
                            <div class="skills-edit-section">
                                <div formArrayName="skills" class="skills-array">
                                    <div *ngFor="let skill of skills.controls; let i = index" class="skill-input-row">
                                        <mat-form-field appearance="outline" class="skill-input">
                                            <mat-label>Habilidad {{i + 1}}</mat-label>
                                            <mat-select [formControlName]="i" required>
                                                <mat-option *ngFor="let skillOption of habilidadesDisponibles"
                                                    [value]="skillOption">
                                                    {{skillOption}}
                                                </mat-option>
                                            </mat-select>
                                            <mat-error *ngIf="skill.invalid && skill.touched">
                                                Selecciona una habilidad
                                            </mat-error>
                                        </mat-form-field>
                                        <button type="button" mat-icon-button color="warn" (click)="removeSkill(i)">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" mat-stroked-button (click)="addSkill()" class="add-btn">
                                    <mat-icon>add</mat-icon>
                                    Agregar Habilidad
                                </button>
                            </div>

                            <!-- Idiomas -->
                            <h3 class="form-section-title">Idiomas</h3>
                            <div class="languages-edit-section">
                                <div formArrayName="languages" class="languages-array">
                                    <div *ngFor="let language of languages.controls; let i = index" [formGroupName]="i"
                                        class="language-input-row">
                                        <mat-form-field appearance="outline" class="language-input">
                                            <mat-label>Idioma</mat-label>
                                            <input matInput formControlName="name" required>
                                            <mat-error
                                                *ngIf="language.get('name')?.invalid && language.get('name')?.touched">
                                                El idioma es requerido
                                            </mat-error>
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="level-input">
                                            <mat-label>Nivel (1-5)</mat-label>
                                            <mat-select formControlName="level" required>
                                                <mat-option *ngFor="let nivel of nivelesIdioma" [value]="nivel">
                                                    {{nivel}}
                                                </mat-option>
                                            </mat-select>
                                            <mat-error
                                                *ngIf="language.get('level')?.invalid && language.get('level')?.touched">
                                                El nivel es requerido
                                            </mat-error>
                                        </mat-form-field>
                                        <button type="button" mat-icon-button color="warn" (click)="removeLanguage(i)">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" mat-stroked-button (click)="addLanguage()" class="add-btn">
                                    <mat-icon>add</mat-icon>
                                    Agregar Idioma
                                </button>
                            </div>

                            <!-- Curriculum -->
                            <h3 class="form-section-title">Curriculum Vitae</h3>
                            <div class="cv-upload-section">
                                <input type="file" #cvInput accept=".pdf" (change)="onCVSelected($event)"
                                    style="display: none">
                                <button type="button" mat-stroked-button (click)="cvInput.click()" class="upload-btn">
                                    <mat-icon>upload_file</mat-icon>
                                    {{selectedCVFile() ? 'Cambiar CV' : 'Subir CV (PDF)'}}
                                </button>
                                <span *ngIf="selectedCVFile()" class="file-selected">
                                    Archivo seleccionado: {{selectedCVFile()!.name}}
                                </span>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>
            </div>

            <!-- Vista normal (no edición) con grid layout -->
            <div *ngIf="!isEditing()" class="profile-content">

                <!-- 1. Información Personal (grid-area: info-personal) -->
                <app-info-card *ngIf="personalInfoData()" [data]="personalInfoData()!">
                </app-info-card>

                <!-- 2. Sobre Mí (grid-area: sobre-mi) -->
                <mat-card class="modern-card about-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">info</mat-icon>
                            Sobre Mí
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <p class="about-text">{{perfilAlumno()?.description}}</p>
                    </mat-card-content>
                </mat-card>

                <!-- 3. Habilidades (grid-area: skills) -->
                <app-skills-card *ngIf="perfilAlumno()?.skills" title="Habilidades Técnicas"
                    [skills]="perfilAlumno()!.skills">
                </app-skills-card>

                <!-- 4. Idiomas (grid-area: idiomas) -->
                <mat-card class="modern-card languages-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">language</mat-icon>
                            Idiomas
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="languages-list">
                            <div *ngFor="let language of perfilAlumno()?.languages" class="language-item">
                                <div class="language-info">
                                    <span class="language-name">{{language.name}}</span>
                                    <span class="language-level">Nivel {{language.level}}/5</span>
                                </div>
                                <mat-divider></mat-divider>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>

                <!-- 5. Materias Aprobadas (grid-area: materias) -->
                <mat-card class="modern-card subjects-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">library_books</mat-icon>
                            Materias Aprobadas
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="subjects-summary" *ngIf="materiasAlumno.length">
                            <div class="summary-item">
                                <span class="summary-label">Materias cargadas</span>
                                <span class="summary-value">{{totalMaterias}}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Promedio general</span>
                                <span class="summary-value">{{promedioMaterias | number:'1.2-2'}}</span>
                            </div>
                        </div>

                        <div class="subjects-upload">
                            <div class="upload-info">
                                <mat-icon>upload_file</mat-icon>
                                <div>
                                    <h4>Planilla de materias</h4>
                                    <p>Formato permitido: .xls (Alumnos Web)</p>
                                </div>
                            </div>
                            <div class="upload-actions">
                                <input type="file" #materiasInput accept=".xls"
                                    (change)="onMateriasFileSelected($event)" hidden>
                                <button mat-stroked-button class="upload-btn" (click)="materiasInput.click()"
                                    [disabled]="isMateriasUploading">
                                    <mat-icon *ngIf="!isMateriasUploading">cloud_upload</mat-icon>
                                    <mat-icon *ngIf="isMateriasUploading" class="spin">autorenew</mat-icon>
                                    {{isMateriasUploading ? 'Subiendo...' : 'Subir .xls'}}
                                </button>
                            </div>
                        </div>

                        <div class="file-processing" *ngIf="selectedMateriasFileName && isMateriasUploading">
                            Procesando {{selectedMateriasFileName}}...
                        </div>

                        <div class="subjects-error" *ngIf="materiasError">
                            <mat-icon>error_outline</mat-icon>
                            <span>{{materiasError}}</span>
                        </div>

                        <div class="subjects-loading" *ngIf="isMateriasLoading">
                            <div class="loading-spinner"></div>
                            <p>Actualizando materias...</p>
                        </div>

                        <ng-container *ngIf="!isMateriasLoading">
                            <div class="subjects-table" *ngIf="materiasAlumno.length; else emptySubjects">
                                <div class="table-header">
                                    <span>Materia</span>
                                    <span>Fecha</span>
                                    <span>Nota</span>
                                    <span>Estado</span>
                                </div>
                                <div class="table-row" *ngFor="let materia of materiasAlumno; trackBy: trackByMateria">
                                    <div class="materia-name">
                                        <span class="materia-title">{{materia.nombre}}</span>
                                        <span class="materia-code" *ngIf="materia.codigo">Código
                                            {{materia.codigo}}</span>
                                    </div>
                                    <span class="materia-date">{{materia.fechaAprobacion | date:'dd/MM/yyyy'}}</span>
                                    <span class="materia-grade">{{materia.nota | number:'1.0-1'}}</span>
                                    <span class="materia-status">{{materia.estado}}</span>
                                </div>
                            </div>
                            <ng-template #emptySubjects>
                                <div class="subjects-empty">
                                    <mat-icon>inventory_2</mat-icon>
                                    <p>Subí tu .xls de Alumnos Web para visualizar tus materias aprobadas.</p>
                                </div>
                            </ng-template>
                        </ng-container>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </div>
</div>