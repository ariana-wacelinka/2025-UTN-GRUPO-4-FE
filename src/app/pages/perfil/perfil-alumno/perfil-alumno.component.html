<div class="perfil-container">
    <div class="container-modern animate-fade-in">

        <!-- Loading indicator -->
        <div *ngIf="isLoading()" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Cargando perfil...</p>
        </div>

        <!-- Contenido del perfil -->
        <div *ngIf="!isLoading() && perfilAlumno()">

            <!-- Header del perfil usando componente compartido -->
            <app-profile-header [data]="profileHeaderData()!" [socialLinks]="socialLinksCompact()"
                [isEditing]="isEditing" [imagePreview]="imagePreview" (editProfile)="onEditProfile()"
                (saveChanges)="onSaveChanges()" (cancelEdit)="onCancelEdit()" (downloadCV)="onDownloadCV()"
                (imageSelected)="onImageSelected($event)">
            </app-profile-header>

            <!-- Formulario de edición -->
            <div *ngIf="isEditing()" class="edit-form-container">
                <mat-card class="modern-card edit-form">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">edit</mat-icon>
                            Editar Información Personal
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <form [formGroup]="editForm" class="edit-form-grid">
                            <!-- Información Personal -->
                            <h3 class="form-section-title">Información Personal</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Nombre</mat-label>
                                    <input matInput formControlName="name" required placeholder="Ingresa tu nombre">
                                    <mat-error *ngIf="f['name'].invalid && f['name'].touched">
                                        El nombre es requerido y debe tener al menos 2 caracteres
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Apellido</mat-label>
                                    <input matInput formControlName="surname" required placeholder="Ingresa tu apellido">
                                    <mat-error *ngIf="f['surname'].invalid && f['surname'].touched">
                                        El apellido es requerido y debe tener al menos 2 caracteres
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Email</mat-label>
                                    <input matInput formControlName="email" type="email" required placeholder="ejemplo@correo.com">
                                    <mat-error *ngIf="f['email'].invalid && f['email'].touched">
                                        Ingrese un email válido
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Teléfono</mat-label>
                                    <input matInput formControlName="phone" required placeholder="+54 9 11 1234-5678">
                                    <mat-error *ngIf="f['phone'].invalid && f['phone'].touched">
                                        El teléfono es requerido
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Ubicación</mat-label>
                                    <input matInput formControlName="location" required placeholder="Ciudad, País">
                                    <mat-error *ngIf="f['location'].invalid && f['location'].touched">
                                        La ubicación es requerida
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Fecha de Nacimiento</mat-label>
                                    <input matInput type="date" formControlName="dateOfBirth" required placeholder="dd/mm/aaaa">
                                    <mat-error *ngIf="f['dateOfBirth'].invalid && f['dateOfBirth'].touched">
                                        La fecha de nacimiento es requerida
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>Descripción</mat-label>
                                <textarea matInput formControlName="description" rows="4" maxlength="500" placeholder="Cuéntanos sobre ti, tus intereses y objetivos profesionales..."></textarea>
                                <mat-hint>{{f['description'].value?.length || 0}}/500</mat-hint>
                                <mat-error *ngIf="f['description'].invalid && f['description'].touched">
                                    La descripción no puede exceder 500 caracteres
                                </mat-error>
                            </mat-form-field>

                            <!-- Información Académica -->
                            <h3 class="form-section-title">Información Académica</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Carrera</mat-label>
                                    <input matInput formControlName="career" required placeholder="Ej. Ingeniería en Sistemas">
                                    <mat-error *ngIf="f['career'].invalid && f['career'].touched">
                                        La carrera es requerida
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Año</mat-label>
                                    <mat-select formControlName="currentYearLevel" required>
                                        <mat-option value="1">1er año</mat-option>
                                        <mat-option value="2">2do año</mat-option>
                                        <mat-option value="3">3er año</mat-option>
                                        <mat-option value="4">4to año</mat-option>
                                        <mat-option value="5">5to año</mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="f['currentYearLevel'].invalid && f['currentYearLevel'].touched">
                                        El año es requerido
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>Institución</mat-label>
                                <input matInput formControlName="institution" required placeholder="Ej. UTN FRLP">
                                <mat-error *ngIf="f['institution'].invalid && f['institution'].touched">
                                    La institución es requerida
                                </mat-error>
                            </mat-form-field>

                            <!-- Habilidades con autocomplete -->
                            <h3 class="form-section-title">Skills/Habilidades</h3>
                            <div class="skills-edit-section">
                                <label class="skills-label">Tecnologías y Habilidades</label>
                                <mat-form-field appearance="outline" class="skills-input">
                                    <mat-label>Habilidades</mat-label>
                                    <input
                                        matInput
                                        [(ngModel)]="skillInput"
                                        name="skillInput"
                                        [ngModelOptions]="{standalone: true}"
                                        (input)="buscarHabilidades($event)"
                                        [matAutocomplete]="skillsAuto"
                                        placeholder="Buscar o crear habilidad..."
                                    />
                                    <mat-autocomplete
                                        #skillsAuto="matAutocomplete"
                                        (optionSelected)="seleccionarHabilidad($event)"
                                    >
                                        <mat-option
                                            *ngFor="let habilidad of skillsSugeridas$ | async"
                                            [value]="habilidad">
                                            {{ habilidad }}
                                        </mat-option>
                                    </mat-autocomplete>
                                </mat-form-field>

                                <mat-chip-set class="chips">
                                    <mat-chip
                                        *ngFor="let skill of skillsSignal()"
                                        (removed)="removeSkill(skill)"
                                        class="skill-chip">
                                        {{ skill }}
                                        <mat-icon matChipRemove>cancel</mat-icon>
                                    </mat-chip>
                                </mat-chip-set>

                                <div class="skills-hint">
                                    <mat-icon class="hint-icon">info</mat-icon>
                                    <span>Busca habilidades existentes o crea nuevas escribiendo el nombre</span>
                                </div>
                            </div>

                            <!-- Idiomas -->
                            <h3 class="form-section-title">Idiomas</h3>
                            <div class="languages-edit-section">
                                <div formArrayName="languages" class="languages-array">
                                    <div *ngFor="let language of languages.controls; let i = index" [formGroupName]="i"
                                        class="language-input-row">
                                        <mat-form-field appearance="outline" class="language-input">
                                            <mat-label>Idioma</mat-label>
                                            <input matInput formControlName="name" required placeholder="Ej. Español">
                                            <mat-error
                                                *ngIf="language.get('name')?.invalid && language.get('name')?.touched">
                                                El idioma es requerido
                                            </mat-error>
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="level-input">
                                            <mat-label>Nivel (1-5)</mat-label>
                                            <mat-select formControlName="level" required>
                                                <mat-option *ngFor="let nivel of nivelesIdioma" [value]="nivel">
                                                    {{nivel}}
                                                </mat-option>
                                            </mat-select>
                                            <mat-error
                                                *ngIf="language.get('level')?.invalid && language.get('level')?.touched">
                                                El nivel es requerido
                                            </mat-error>
                                        </mat-form-field>
                                        <button type="button" mat-icon-button color="warn" (click)="removeLanguage(i)">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" mat-stroked-button (click)="addLanguage()" class="add-btn">
                                    <mat-icon>add</mat-icon>
                                    Agregar Idioma
                                </button>
                            </div>

                            <!-- Curriculum -->
                            <h3 class="form-section-title">Curriculum Vitae</h3>
                            <div class="cv-upload-section">
                                <input type="file" #cvInput accept=".pdf" (change)="onCVSelected($event)"
                                    class="hidden-file-input" title="Seleccionar archivo CV">

                                <!-- Botón de selección de archivo -->
                                <button type="button" mat-stroked-button (click)="cvInput.click()" class="upload-btn"
                                    *ngIf="!isCVUploadPending() && !isUploadingCV()">
                                    <mat-icon>upload_file</mat-icon>
                                    {{selectedCVFile() ? 'Cambiar CV' : 'Subir CV (PDF)'}}
                                </button>

                                <!-- Confirmación de subida -->
                                <div *ngIf="isCVUploadPending()" class="cv-confirmation">
                                    <div class="file-info">
                                        <mat-icon>description</mat-icon>
                                        <span>{{selectedCVFile()!.name}}</span>
                                    </div>
                                    <div class="confirmation-actions">
                                        <button type="button" mat-icon-button color="primary"
                                            (click)="onConfirmCVUpload()" matTooltip="Confirmar">
                                            <mat-icon>check</mat-icon>
                                        </button>
                                        <button type="button" mat-icon-button color="warn"
                                            (click)="onCancelCVUpload()" matTooltip="Cancelar">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </div>
                                </div>

                                <!-- Estado de subida -->
                                <div *ngIf="isUploadingCV()" class="cv-uploading">
                                    <mat-icon class="spin">autorenew</mat-icon>
                                    <span>Subiendo CV...</span>
                                </div>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>
            </div>

            <!-- Vista normal (no edición) con grid layout -->
            <div *ngIf="!isEditing()" class="profile-content">

                <!-- 1. Información Personal (grid-area: info-personal) -->
                <app-info-card *ngIf="personalInfoData()" [data]="personalInfoData()!">
                </app-info-card>

                <!-- 2. Sobre Mí (grid-area: sobre-mi) -->
                <mat-card class="modern-card about-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">info</mat-icon>
                            Sobre Mí
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <p class="about-text">{{perfilAlumno()?.description}}</p>
                    </mat-card-content>
                </mat-card>

                <!-- 3. Habilidades (grid-area: skills) -->
                <app-skills-card title="Habilidades Técnicas"
                    [skills]="perfilAlumno()!.skills">
                </app-skills-card>

                <!-- 4. Idiomas (grid-area: idiomas) -->
                <mat-card class="modern-card languages-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">language</mat-icon>
                            Idiomas
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="languages-list">
                            <div *ngFor="let language of perfilAlumno()?.languages" class="language-item">
                                <div class="language-info">
                                    <span class="language-name">{{language.name}}</span>
                                    <span class="language-level">Nivel {{language.level}}/5</span>
                                </div>
                                <mat-divider></mat-divider>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>

                <!-- 5. Ofertas Aplicadas (solo para perfil propio) -->
                <mat-card class="modern-card applied-offers-card" *ngIf="isOwnProfile()">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">work_outline</mat-icon>
                            Mis Aplicaciones
                            <span class="applications-count" *ngIf="totalOfertasAplicadas > 0">({{totalOfertasAplicadas}})</span>
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <!-- Loading state -->
                        <div class="ofertas-loading" *ngIf="isOfertasLoading">
                            <div class="loading-spinner"></div>
                            <p>Cargando aplicaciones...</p>
                        </div>

                        <!-- Error state -->
                        <div class="ofertas-error" *ngIf="ofertasError && !isOfertasLoading">
                            <mat-icon>error_outline</mat-icon>
                            <span>{{ofertasError}}</span>
                        </div>

                        <!-- Content -->
                        <ng-container *ngIf="!isOfertasLoading && !ofertasError">
                            <div class="applied-offers-list" *ngIf="ofertasAplicadas.length; else emptyOffers">
                                <div class="offer-card" *ngFor="let aplicacion of ofertasAplicadas; trackBy: trackByOferta">
                                    <!-- Solo mostrar si la oferta existe -->
                                    <ng-container *ngIf="aplicacion.offer">
                                        <!-- Status Badge -->
                                        <!-- <div class="application-status" [class]="getStatusClass(aplicacion.status)">
                                            <mat-icon>{{getStatusIcon(aplicacion.status)}}</mat-icon>
                                            <span>{{getStatusText(aplicacion.status)}}</span>
                                        </div> -->

                                        <!-- Company Info (si está disponible) -->
                                        <div class="company-section" *ngIf="aplicacion.offer.company">
                                            <div class="company-logo" *ngIf="aplicacion.offer.company.imageUrl">
                                                <img [src]="aplicacion.offer.company.imageUrl"
                                                     [alt]="aplicacion.offer.company.name || 'Logo de la empresa'"
                                                     [title]="aplicacion.offer.company.name || 'Empresa'"
                                                     onerror="this.style.display='none'">
                                            </div>
                                            <div class="company-info">
                                                <h5 class="company-name">{{aplicacion.offer.company.name}}</h5>
                                                <p class="company-industry" *ngIf="aplicacion.offer.company.industry">
                                                    {{aplicacion.offer.company.industry}}
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Offer Header -->
                                        <div class="offer-header">
                                            <div class="offer-title-section">
                                                <h4 class="offer-title">{{aplicacion.offer.title}}</h4>
                                                <div class="offer-meta">
                                                    <span class="application-date" *ngIf="aplicacion.applicationDate">
                                                        <mat-icon>calendar_today</mat-icon>
                                                        Aplicado el {{aplicacion.applicationDate | date:'dd/MM/yyyy'}}
                                                    </span>
                                                </div>
                                            </div>

                                            <!-- Quick Info Pills -->
                                            <div class="offer-pills">
                                                <mat-chip-set class="info-chips">
                                                    <mat-chip class="modality-chip" [class]="getModalityClass(aplicacion.offer.modality)">
                                                        <mat-icon>{{getModalityIcon(aplicacion.offer.modality)}}</mat-icon>
                                                        {{getModalityText(aplicacion.offer.modality)}}
                                                    </mat-chip>
                                                    <mat-chip class="location-chip">
                                                        <mat-icon>place</mat-icon>
                                                        {{aplicacion.offer.location}}
                                                    </mat-chip>
                                                    <mat-chip class="payment-chip" *ngIf="aplicacion.offer.estimatedPayment">
                                                        <mat-icon>payments</mat-icon>
                                                        {{aplicacion.offer.estimatedPayment}}
                                                    </mat-chip>
                                                </mat-chip-set>
                                            </div>
                                        </div>

                                        <!-- Offer Description -->
                                        <div class="offer-content">
                                            <div class="offer-description">
                                                <p class="description-text">{{aplicacion.offer.description}}</p>
                                                <button mat-button class="expand-btn" *ngIf="isDescriptionLong(aplicacion.offer.description)">
                                                    <mat-icon>expand_more</mat-icon>
                                                    Ver más
                                                </button>
                                            </div>

                                            <!-- Tags/Skills si están disponibles -->
                                            <!-- <div class="offer-tags" *ngIf="aplicacion.offer.tags && aplicacion.offer.tags.length">
                                                <h6>Tecnologías requeridas:</h6>
                                                <mat-chip-set class="skills-chips">
                                                    <mat-chip *ngFor="let tag of aplicacion.offer.tags" class="skill-tag">
                                                        {{tag}}
                                                    </mat-chip>
                                                </mat-chip-set>
                                            </div> -->
                                        </div>

                                        <!-- Custom Cover Letter -->
                                        <div class="cover-letter-section" *ngIf="aplicacion.customCoverLetter">
                                            <div class="cover-letter-header">
                                                <mat-icon class="letter-icon">mail_outline</mat-icon>
                                                <span class="letter-title">Tu carta de presentación</span>
                                                <button mat-icon-button class="toggle-letter" (click)="toggleCoverLetter(aplicacion.id)">
                                                    <mat-icon>{{isCoverLetterExpanded(aplicacion.id) ? 'expand_less' : 'expand_more'}}</mat-icon>
                                                </button>
                                            </div>
                                            <div class="cover-letter-content"
                                                 [class.expanded]="isCoverLetterExpanded(aplicacion.id)"
                                                 *ngIf="isCoverLetterExpanded(aplicacion.id)">
                                                <p class="cover-letter-text">{{aplicacion.customCoverLetter}}</p>
                                            </div>
                                        </div>

                                        <!-- Timeline/Dates -->
                                        <div class="application-timeline" *ngIf="hasTimelineData(aplicacion)">
                                            <div class="timeline-item">
                                                <mat-icon class="timeline-icon">send</mat-icon>
                                                <span>Aplicación enviada: {{aplicacion.applicationDate | date:'dd/MM/yyyy'}}</span>
                                            </div>
                                            <div class="timeline-item" *ngIf="aplicacion.offer.expirationDate">
                                                <mat-icon class="timeline-icon">schedule</mat-icon>
                                                <span>Fecha límite: {{aplicacion.offer.expirationDate | date:'dd/MM/yyyy'}}</span>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="offer-actions">
                                            <button mat-flat-button color="primary" (click)="verDetalleOferta(aplicacion.offer.id)">
                                                <mat-icon>visibility</mat-icon>
                                                Ver Detalle
                                            </button>
                                            <button mat-stroked-button color="warn" (click)="retirarAplicacion(aplicacion.id)"
                                                    *ngIf="canWithdrawApplication(aplicacion.status)">
                                                <mat-icon>cancel</mat-icon>
                                                Cancelar Aplicación
                                            </button>
                                        </div>
                                    </ng-container>

                                    <!-- Fallback para cuando la oferta no existe o fue eliminada -->
                                    <ng-container *ngIf="!aplicacion.offer">
                                        <div class="offer-header">
                                            <h4 class="offer-title error-title">Oferta no disponible</h4>
                                            <div class="offer-details">
                                                <span class="offer-error">
                                                    <mat-icon>error_outline</mat-icon>
                                                    Esta oferta ya no está disponible o fue eliminada
                                                </span>
                                            </div>
                                        </div>

                                        <div class="cover-letter" *ngIf="aplicacion.customCoverLetter">
                                            <div class="cover-letter-header">
                                                <mat-icon>mail</mat-icon>
                                                <span>Tu carta de presentación:</span>
                                            </div>
                                            <p class="cover-letter-text">{{aplicacion.customCoverLetter}}</p>
                                        </div>

                                        <mat-divider></mat-divider>
                                    </ng-container>
                                </div>
                            </div>                            <ng-template #emptyOffers>
                                <div class="offers-empty">
                                    <mat-icon>work_off</mat-icon>
                                    <h4>No has aplicado a ninguna oferta aún</h4>
                                    <p>Explora las ofertas disponibles y comienza a aplicar a las que más te interesen.</p>
                                </div>
                            </ng-template>
                        </ng-container>
                    </mat-card-content>
                </mat-card>

                <!-- 6. Materias Aprobadas (grid-area: materias) -->
                <mat-card class="modern-card subjects-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">library_books</mat-icon>
                            Materias Aprobadas
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="subjects-summary" *ngIf="materiasAlumno.length">
                            <div class="summary-item">
                                <span class="summary-label">Materias cargadas</span>
                                <span class="summary-value">{{totalMaterias}}</span>
                             </div>
                            <div class="summary-item">
                                <span class="summary-label">Promedio general</span>
                                <span class="summary-value">{{promedioMaterias | number:'1.2-2'}}</span>
                            </div>
                        </div>

                        <div class="subjects-upload">
                            <div class="upload-info">
                                <mat-icon>upload_file</mat-icon>
                                <div>
                                    <h4>Planilla de materias</h4>
                                    <p>Formato permitido: .xls (Alumnos Web)</p>
                                </div>
                            </div>
                            <div class="upload-actions">
                                <input type="file" #materiasInput accept=".xls"
                                    (change)="onMateriasFileSelected($event)" hidden>
                                <button mat-stroked-button class="upload-btn" (click)="materiasInput.click()"
                                    [disabled]="isMateriasUploading">
                                    <mat-icon *ngIf="!isMateriasUploading">cloud_upload</mat-icon>
                                    <mat-icon *ngIf="isMateriasUploading" class="spin">autorenew</mat-icon>
                                    {{isMateriasUploading ? 'Subiendo...' : 'Subir .xls'}}
                                </button>
                            </div>
                        </div>

                        <div class="file-processing" *ngIf="selectedMateriasFileName && isMateriasUploading">
                            Procesando {{selectedMateriasFileName}}...
                        </div>

                        <div class="subjects-error" *ngIf="materiasError">
                            <mat-icon>error_outline</mat-icon>
                            <span>{{materiasError}}</span>
                        </div>

                        <div class="subjects-loading" *ngIf="isMateriasLoading">
                            <div class="loading-spinner"></div>
                            <p>Actualizando materias...</p>
                        </div>

                        <ng-container *ngIf="!isMateriasLoading">
                            <div class="subjects-table" *ngIf="materiasAlumno.length; else emptySubjects">
                                <div class="table-header">
                                    <span>Materia</span>
                                    <span>Fecha</span>
                                    <span>Nota</span>
                                    <span>Estado</span>
                                </div>
                                <div class="table-row" *ngFor="let materia of materiasAlumno; trackBy: trackByMateria">
                                    <div class="materia-name">
                                        <span class="materia-title">{{materia.nombre}}</span>
                                        <span class="materia-code" *ngIf="materia.codigo">Código
                                            {{materia.codigo}}</span>
                                    </div>
                                    <span class="materia-date">{{materia.fechaAprobacion | date:'dd/MM/yyyy'}}</span>
                                    <span class="materia-grade">{{materia.nota | number:'1.0-1'}}</span>
                                    <span class="materia-status">{{materia.estado}}</span>
                                </div>
                            </div>
                            <ng-template #emptySubjects>
                                <div class="subjects-empty">
                                    <mat-icon>inventory_2</mat-icon>
                                    <p>Subí tu .xls de Alumnos Web para visualizar tus materias aprobadas.</p>
                                </div>
                            </ng-template>
                        </ng-container>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </div>
</div>
