<div class="perfil-container">
    <div class="container-modern animate-fade-in">

        <!-- Loading indicator -->
        <div *ngIf="isLoading()" class="loading-container">
            <div class="loading-spinner"></div>
            <p>Cargando perfil...</p>
        </div>

        <!-- Contenido del perfil -->
        <div *ngIf="!isLoading() && perfilAlumno()">

            <!-- Header del perfil usando componente compartido -->
            <app-profile-header [data]="profileHeaderData()!" [socialLinks]="socialLinksCompact()"
                [isEditing]="isEditing" [imagePreview]="imagePreview" [canEdit]="isOwnProfile()"
                (editProfile)="onEditProfile()" (saveChanges)="onSaveChanges()" (cancelEdit)="onCancelEdit()"
                (downloadCV)="onDownloadCV()" (imageSelected)="onImageSelected($event)">
            </app-profile-header>

            <!-- Formulario de edición -->
            <div *ngIf="isEditing()" class="edit-form-container">
                <mat-card class="modern-card edit-form">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">edit</mat-icon>
                            Editar Información Personal
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <form [formGroup]="editForm" class="edit-form-grid">
                            <!-- Información Personal -->
                            <h3 class="form-section-title">Información Personal</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Nombre</mat-label>
                                    <input matInput formControlName="name" required placeholder="Ingresa tu nombre">
                                    <mat-error *ngIf="f['name'].invalid && f['name'].touched">
                                        El nombre es requerido y debe tener al menos 2 caracteres
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Apellido</mat-label>
                                    <input matInput formControlName="surname" required placeholder="Ingresa tu apellido">
                                    <mat-error *ngIf="f['surname'].invalid && f['surname'].touched">
                                        El apellido es requerido y debe tener al menos 2 caracteres
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Email</mat-label>
                                    <input matInput formControlName="email" type="email" required placeholder="ejemplo@correo.com">
                                    <mat-error *ngIf="f['email'].invalid && f['email'].touched">
                                        Ingrese un email válido
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Teléfono</mat-label>
                                    <input matInput formControlName="phone" required placeholder="+54 9 11 1234-5678">
                                    <mat-error *ngIf="f['phone'].invalid && f['phone'].touched">
                                        El teléfono es requerido
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Ubicación</mat-label>
                                    <input matInput formControlName="location" required placeholder="Ciudad, País">
                                    <mat-error *ngIf="f['location'].invalid && f['location'].touched">
                                        La ubicación es requerida
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Fecha de Nacimiento</mat-label>
                                    <input matInput type="date" formControlName="dateOfBirth" required placeholder="dd/mm/aaaa">
                                    <mat-error *ngIf="f['dateOfBirth'].invalid && f['dateOfBirth'].touched">
                                        La fecha de nacimiento es requerida
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>Descripción</mat-label>
                                <textarea matInput formControlName="description" rows="4" maxlength="500" placeholder="Cuéntanos sobre ti, tus intereses y objetivos profesionales..."></textarea>
                                <mat-hint>{{f['description'].value?.length || 0}}/500</mat-hint>
                                <mat-error *ngIf="f['description'].invalid && f['description'].touched">
                                    La descripción no puede exceder 500 caracteres
                                </mat-error>
                            </mat-form-field>

                            <!-- Información Académica -->
                            <h3 class="form-section-title">Información Académica</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Carrera</mat-label>
                                    <input matInput formControlName="career" required placeholder="Ej. Ingeniería en Sistemas">
                                    <mat-error *ngIf="f['career'].invalid && f['career'].touched">
                                        La carrera es requerida
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>Año</mat-label>
                                    <mat-select formControlName="currentYearLevel" required>
                                        <mat-option value="1">1er año</mat-option>
                                        <mat-option value="2">2do año</mat-option>
                                        <mat-option value="3">3er año</mat-option>
                                        <mat-option value="4">4to año</mat-option>
                                        <mat-option value="5">5to año</mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="f['currentYearLevel'].invalid && f['currentYearLevel'].touched">
                                        El año es requerido
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="form-field full-width">
                                <mat-label>Institución</mat-label>
                                <input matInput formControlName="institution" required placeholder="Ej. UTN FRLP">
                                <mat-error *ngIf="f['institution'].invalid && f['institution'].touched">
                                    La institución es requerida
                                </mat-error>
                            </mat-form-field>

                            <!-- Redes Sociales y Enlaces Profesionales -->
                            <h3 class="form-section-title">Redes Sociales y Enlaces</h3>

                            <div class="form-row">
                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>LinkedIn</mat-label>
                                    <input matInput formControlName="linkedinUrl" type="url" placeholder="https://linkedin.com/in/tu-perfil">
                                    <mat-icon matPrefix class="social-icon linkedin-icon">work</mat-icon>
                                    <mat-hint>URL de tu perfil de LinkedIn (opcional)</mat-hint>
                                    <mat-error *ngIf="f['linkedinUrl'].hasError('invalidUrl')">
                                        Ingresa una URL válida (ej: https://linkedin.com/in/usuario)
                                    </mat-error>
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="form-field">
                                    <mat-label>GitHub</mat-label>
                                    <input matInput formControlName="githubUrl" type="url" placeholder="https://github.com/tu-usuario">
                                    <mat-icon matPrefix class="social-icon github-icon">code</mat-icon>
                                    <mat-hint>URL de tu perfil de GitHub (opcional)</mat-hint>
                                    <mat-error *ngIf="f['githubUrl'].hasError('invalidUrl')">
                                        Ingresa una URL válida (ej: https://github.com/usuario)
                                    </mat-error>
                                </mat-form-field>
                            </div>

                            <!-- Habilidades con autocomplete -->
                            <h3 class="form-section-title">Skills/Habilidades</h3>
                            <div class="skills-edit-section">
                                <label class="skills-label">Tecnologías y Habilidades</label>
                                <mat-form-field appearance="outline" class="skills-input">
                                    <mat-label>Habilidades</mat-label>
                                    <input
                                        matInput
                                        [(ngModel)]="skillInput"
                                        name="skillInput"
                                        [ngModelOptions]="{standalone: true}"
                                        (input)="buscarHabilidades($event)"
                                        [matAutocomplete]="skillsAuto"
                                        placeholder="Buscar o crear habilidad..."
                                    />
                                    <mat-autocomplete
                                        #skillsAuto="matAutocomplete"
                                        (optionSelected)="seleccionarHabilidad($event)"
                                    >
                                        <mat-option
                                            *ngFor="let habilidad of skillsSugeridas$ | async"
                                            [value]="habilidad">
                                            {{ habilidad }}
                                        </mat-option>
                                    </mat-autocomplete>
                                </mat-form-field>

                                <mat-chip-set class="chips">
                                    <mat-chip
                                        *ngFor="let skill of skillsSignal()"
                                        (removed)="removeSkill(skill)"
                                        class="skill-chip">
                                        {{ skill }}
                                        <mat-icon matChipRemove>cancel</mat-icon>
                                    </mat-chip>
                                </mat-chip-set>

                                <div class="skills-hint">
                                    <mat-icon class="hint-icon">info</mat-icon>
                                    <span>Busca habilidades existentes o crea nuevas escribiendo el nombre</span>
                                </div>
                            </div>

                            <!-- Idiomas -->
                            <h3 class="form-section-title">Idiomas</h3>
                            <div class="languages-edit-section">
                                <div formArrayName="languages" class="languages-array">
                                    <div *ngFor="let language of languages.controls; let i = index" [formGroupName]="i"
                                        class="language-input-row">
                                        <mat-form-field appearance="outline" class="language-input">
                                            <mat-label>Idioma</mat-label>
                                            <input matInput formControlName="name" required placeholder="Ej. Español">
                                            <mat-error
                                                *ngIf="language.get('name')?.invalid && language.get('name')?.touched">
                                                El idioma es requerido
                                            </mat-error>
                                        </mat-form-field>
                                        <mat-form-field appearance="outline" class="level-input">
                                            <mat-label>Nivel (1-5)</mat-label>
                                            <mat-select formControlName="level" required>
                                                <mat-option *ngFor="let nivel of nivelesIdioma" [value]="nivel">
                                                    {{nivel}}
                                                </mat-option>
                                            </mat-select>
                                            <mat-error
                                                *ngIf="language.get('level')?.invalid && language.get('level')?.touched">
                                                El nivel es requerido
                                            </mat-error>
                                        </mat-form-field>
                                        <button type="button" mat-icon-button color="warn" (click)="removeLanguage(i)">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" mat-stroked-button (click)="addLanguage()" class="add-btn">
                                    <mat-icon>add</mat-icon>
                                    Agregar Idioma
                                </button>
                            </div>

                            <!-- Curriculum -->
                            <h3 class="form-section-title">Curriculum Vitae</h3>
                            <div class="cv-upload-section">
                                <input type="file" #cvInput accept=".pdf" (change)="onCVSelected($event)"
                                    class="hidden-file-input" title="Seleccionar archivo CV">

                                <!-- Estado: Ya tiene CV cargado -->
                                <div *ngIf="hasCVUploaded() && !isCVUploadPending() && !isUploadingCV()" class="cv-current-file">
                                    <div class="current-file-info">
                                        <mat-icon class="file-icon">check_circle</mat-icon>
                                        <div class="file-details">
                                            <span class="file-label">CV cargado</span>
                                            <span class="file-name">{{perfilAlumno()?.cvFileName || 'curriculum.pdf'}}</span>
                                        </div>
                                    </div>
                                    <button type="button" mat-stroked-button (click)="cvInput.click()" class="replace-btn">
                                        <mat-icon>sync</mat-icon>
                                        Reemplazar CV
                                    </button>
                                </div>

                                <!-- Botón de selección de archivo (cuando no tiene CV) -->
                                <button type="button" mat-stroked-button (click)="cvInput.click()" class="upload-btn"
                                    *ngIf="!hasCVUploaded() && !isCVUploadPending() && !isUploadingCV()">
                                    <mat-icon>upload_file</mat-icon>
                                    Subir CV (PDF)
                                </button>

                                <!-- Confirmación de subida -->
                                <div *ngIf="isCVUploadPending()" class="cv-confirmation">
                                    <div class="file-info">
                                        <mat-icon>description</mat-icon>
                                        <div class="file-text">
                                            <span class="file-name">{{selectedCVFile()!.name}}</span>
                                            <span class="file-size">{{(selectedCVFile()!.size / 1024).toFixed(0)}} KB</span>
                                        </div>
                                    </div>
                                    <div class="confirmation-actions">
                                        <button type="button" mat-mini-fab color="primary"
                                            (click)="onConfirmCVUpload()" matTooltip="Confirmar subida">
                                            <mat-icon>check</mat-icon>
                                        </button>
                                        <button type="button" mat-mini-fab color="warn"
                                            (click)="onCancelCVUpload()" matTooltip="Cancelar">
                                            <mat-icon>close</mat-icon>
                                        </button>
                                    </div>
                                </div>

                                <!-- Estado de subida -->
                                <div *ngIf="isUploadingCV()" class="cv-uploading">
                                    <mat-icon class="spin">autorenew</mat-icon>
                                    <span>Subiendo CV...</span>
                                </div>
                            </div>
                        </form>
                    </mat-card-content>
                </mat-card>
            </div>

            <!-- Vista normal (no edición) con grid layout -->
            <div *ngIf="!isEditing()" class="profile-content">

                <!-- 1. Información Personal (grid-area: info-personal) -->
                <app-info-card *ngIf="personalInfoData()" [data]="personalInfoData()!">
                </app-info-card>

                <!-- 2. Sobre Mí (grid-area: sobre-mi) -->
                <mat-card class="modern-card about-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">info</mat-icon>
                            Sobre Mí
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <p class="about-text">{{perfilAlumno()?.description}}</p>
                    </mat-card-content>
                </mat-card>

                <!-- 3. Habilidades (grid-area: skills) -->
                <app-skills-card title="Habilidades Técnicas"
                    [skills]="perfilAlumno()!.skills">
                </app-skills-card>

                <!-- 4. Idiomas (grid-area: idiomas) -->
                <mat-card class="modern-card languages-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">language</mat-icon>
                            Idiomas
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="languages-list">
                            <div *ngFor="let language of perfilAlumno()?.languages" class="language-item">
                                <div class="language-info">
                                    <span class="language-name">{{language.name}}</span>
                                    <span class="language-level">Nivel {{language.level}}/5</span>
                                </div>
                                <mat-divider></mat-divider>
                            </div>
                        </div>
                    </mat-card-content>
                </mat-card>

                <!-- 5. Empresas Asociadas / Reconocimientos (grid-area: empresas) -->
                <mat-card class="modern-card associated-companies-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">verified</mat-icon>
                            Reconocimientos Empresariales
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="companies-grid" *ngIf="hasAssociatedCompanies(); else noCompanies">
                            <div class="company-badge" 
                                 *ngFor="let company of associatedCompanies(); trackBy: trackByCompanyId"
                                 (click)="navigateToCompanyProfile(company.companyId)"
                                 [matTooltip]="'Reconocido por ' + company.companyName">
                                <div class="badge-header">
                                    <div class="company-logo">
                                        <img [src]="company.companyImageUrl || 'https://ui-avatars.com/api/?name=' + company.companyName + '&background=667eea&color=fff'" 
                                             [alt]="company.companyName"
                                             (error)="onImageError($event, company.companyName)">
                                    </div>
                                    <div class="company-info">
                                        <h4 class="company-name">{{company.companyName}}</h4>
                                        <p class="company-industry" *ngIf="company.companyIndustry">
                                            {{company.companyIndustry}}
                                        </p>
                                    </div>
                                </div>
                                <div class="badge-details">
                                    <div class="recognition-type" *ngIf="company.recognitionType">
                                        <mat-icon>workspace_premium</mat-icon>
                                        <span>{{company.recognitionType}}</span>
                                    </div>
                                    <div class="association-date">
                                        <mat-icon>event</mat-icon>
                                        <span>Desde {{company.associationDate | date:'MMM yyyy'}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <ng-template #noCompanies>
                            <div class="empty-state">
                                <mat-icon class="empty-icon">business</mat-icon>
                                <p class="empty-message">Aún no hay reconocimientos empresariales</p>
                                <p class="empty-hint" *ngIf="!isOwnProfile()">Este perfil no ha sido reconocido por ninguna empresa</p>
                            </div>
                        </ng-template>
                    </mat-card-content>
                </mat-card>

                <!-- 6. Experiencia Laboral (grid-area: experiencia) -->
                <mat-card class="modern-card work-experience-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">work</mat-icon>
                            Experiencia Laboral
                        </mat-card-title>
                        <button mat-icon-button 
                                *ngIf="isOwnProfile()"
                                (click)="agregarExperienciaLaboral()"
                                matTooltip="Agregar experiencia laboral">
                            <mat-icon>add_circle</mat-icon>
                        </button>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="experience-timeline" *ngIf="hasWorkExperience(); else noExperience">
                            <div class="experience-item" 
                                 *ngFor="let exp of workExperience(); trackBy: trackByExperienceId">
                                <div class="timeline-marker">
                                    <div class="marker-dot"></div>
                                    <div class="marker-line" *ngIf="!exp.isCurrentJob"></div>
                                </div>
                                <div class="experience-content">
                                    <div class="experience-header">
                                        <div class="title-section">
                                            <h4 class="position-title">{{exp.position}}</h4>
                                            <h5 class="company-name">{{exp.company}}</h5>
                                        </div>
                                        <div class="header-actions">
                                            <div class="current-badge" *ngIf="exp.isCurrentJob">
                                                <mat-chip class="current-chip">
                                                    <mat-icon>schedule</mat-icon>
                                                    Actual
                                                </mat-chip>
                                            </div>
                                            <div class="action-buttons" *ngIf="isOwnProfile()">
                                                <button mat-icon-button 
                                                        (click)="editarExperienciaLaboral(exp)"
                                                        matTooltip="Editar">
                                                    <mat-icon>edit</mat-icon>
                                                </button>
                                                <button mat-icon-button 
                                                        color="warn"
                                                        (click)="eliminarExperienciaLaboral(exp.id!)"
                                                        matTooltip="Eliminar">
                                                    <mat-icon>delete</mat-icon>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="experience-period">
                                        <mat-icon>calendar_today</mat-icon>
                                        <span>
                                            {{formatMonthYear(exp.startDate)}} - 
                                            {{exp.isCurrentJob ? 'Presente' : formatMonthYear(exp.endDate!)}}
                                        </span>
                                        <span class="duration">({{calculateDuration(exp.startDate, exp.endDate)}})</span>
                                    </div>
                                    <p class="experience-description">{{exp.description}}</p>
                                </div>
                            </div>
                        </div>
                        <ng-template #noExperience>
                            <div class="empty-state">
                                <mat-icon class="empty-icon">work_outline</mat-icon>
                                <p class="empty-message">Aún no hay experiencia laboral registrada</p>
                                <p class="empty-hint" *ngIf="isOwnProfile()">Agrega tu experiencia laboral para destacar tu trayectoria profesional</p>
                                <button mat-raised-button 
                                        color="primary" 
                                        *ngIf="isOwnProfile()"
                                        (click)="agregarExperienciaLaboral()"
                                        class="add-first-button">
                                    <mat-icon>add</mat-icon>
                                    Agregar experiencia laboral
                                </button>
                            </div>
                        </ng-template>
                    </mat-card-content>
                </mat-card>

                <!-- 7. Proyectos Personales (grid-area: proyectos) -->
                <mat-card class="modern-card personal-projects-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">code</mat-icon>
                            Proyectos Personales
                        </mat-card-title>
                        <button mat-icon-button 
                                *ngIf="isOwnProfile()"
                                (click)="agregarProyectoPersonal()"
                                matTooltip="Agregar proyecto personal">
                            <mat-icon>add_circle</mat-icon>
                        </button>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="projects-grid" *ngIf="hasPersonalProjects(); else noProjects">
                            <div class="project-card" 
                                 *ngFor="let project of personalProjects(); trackBy: trackByProjectId">
                                <div class="project-header">
                                    <h4 class="project-title">{{project.title}}</h4>
                                    <div class="project-actions">
                                        <button mat-icon-button 
                                                *ngIf="project.projectUrl"
                                                (click)="openExternalLink(project.projectUrl)"
                                                [matTooltip]="'Ver proyecto'">
                                            <mat-icon>open_in_new</mat-icon>
                                        </button>
                                        <button mat-icon-button 
                                                *ngIf="isOwnProfile()"
                                                (click)="editarProyectoPersonal(project)"
                                                matTooltip="Editar">
                                            <mat-icon>edit</mat-icon>
                                        </button>
                                        <button mat-icon-button 
                                                color="warn"
                                                *ngIf="isOwnProfile()"
                                                (click)="eliminarProyectoPersonal(project.id!)"
                                                matTooltip="Eliminar">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                                <p class="project-description">{{project.description}}</p>
                                <div class="project-period" *ngIf="project.startDate">
                                    <mat-icon>schedule</mat-icon>
                                    <span>
                                        {{formatMonthYear(project.startDate)}}
                                        <ng-container *ngIf="project.endDate"> - {{formatMonthYear(project.endDate)}}</ng-container>
                                    </span>
                                </div>
                                <div class="project-technologies">
                                    <mat-chip-set class="tech-chips">
                                        <mat-chip *ngFor="let tech of project.technologies" class="tech-chip">
                                            {{tech}}
                                        </mat-chip>
                                    </mat-chip-set>
                                </div>
                            </div>
                        </div>
                        <ng-template #noProjects>
                            <div class="empty-state">
                                <mat-icon class="empty-icon">code_off</mat-icon>
                                <p class="empty-message">Aún no hay proyectos personales registrados</p>
                                <p class="empty-hint" *ngIf="isOwnProfile()">Muestra tus proyectos personales para destacar tus habilidades</p>
                                <button mat-raised-button 
                                        color="primary" 
                                        *ngIf="isOwnProfile()"
                                        (click)="agregarProyectoPersonal()"
                                        class="add-first-button">
                                    <mat-icon>add</mat-icon>
                                    Agregar proyecto personal
                                </button>
                            </div>
                        </ng-template>
                    </mat-card-content>
                </mat-card>

                <!-- 8. Ofertas Aplicadas - solo para perfil propio (grid-area: applied-offers) -->
                <mat-card class="modern-card applied-offers-card" *ngIf="isOwnProfile()">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">work_outline</mat-icon>
                            Mis Aplicaciones
                            <span class="applications-count" *ngIf="totalOfertasAplicadas > 0">({{totalOfertasAplicadas}})</span>
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <!-- Loading state -->
                        <div class="ofertas-loading" *ngIf="isOfertasLoading">
                            <div class="loading-spinner"></div>
                            <p>Cargando aplicaciones...</p>
                        </div>

                        <!-- Error state -->
                        <div class="ofertas-error" *ngIf="ofertasError && !isOfertasLoading">
                            <mat-icon>error_outline</mat-icon>
                            <span>{{ofertasError}}</span>
                        </div>

                        <!-- Content -->
                        <ng-container *ngIf="!isOfertasLoading && !ofertasError">
                            <div class="applied-offers-list" *ngIf="ofertasAplicadas.length; else emptyOffers">
                                <div class="offer-card" *ngFor="let aplicacion of ofertasAplicadas; trackBy: trackByOferta">
                                    <!-- Solo mostrar si la oferta existe -->
                                    <ng-container *ngIf="aplicacion.offer">
                                        <!-- Status Badge -->
                                        <!-- <div class="application-status" [class]="getStatusClass(aplicacion.status)">
                                            <mat-icon>{{getStatusIcon(aplicacion.status)}}</mat-icon>
                                            <span>{{getStatusText(aplicacion.status)}}</span>
                                        </div> -->

                                        <!-- Company Info (si está disponible) -->
                                        <div class="company-section" *ngIf="aplicacion.offer.company">
                                            <div class="company-logo" *ngIf="aplicacion.offer.company.imageUrl">
                                                <img [src]="aplicacion.offer.company.imageUrl"
                                                     [alt]="aplicacion.offer.company.name || 'Logo de la empresa'"
                                                     [title]="aplicacion.offer.company.name || 'Empresa'"
                                                     onerror="this.style.display='none'">
                                            </div>
                                            <div class="company-info">
                                                <h5 class="company-name">{{aplicacion.offer.company.name}}</h5>
                                                <p class="company-industry" *ngIf="aplicacion.offer.company.industry">
                                                    {{aplicacion.offer.company.industry}}
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Offer Header -->
                                        <div class="offer-header">
                                            <div class="offer-title-section">
                                                <h4 class="offer-title">{{aplicacion.offer.title}}</h4>
                                                <div class="offer-meta">
                                                    <span class="application-date" *ngIf="aplicacion.applicationDate">
                                                        <mat-icon>calendar_today</mat-icon>
                                                        Aplicado el {{aplicacion.applicationDate | date:'dd/MM/yyyy'}}
                                                    </span>
                                                </div>
                                            </div>

                                            <!-- Quick Info Pills -->
                                            <div class="offer-pills">
                                                <mat-chip-set class="info-chips">
                                                    <mat-chip class="modality-chip" [class]="getModalityClass(aplicacion.offer.modality)">
                                                        <mat-icon>{{getModalityIcon(aplicacion.offer.modality)}}</mat-icon>
                                                        {{getModalityText(aplicacion.offer.modality)}}
                                                    </mat-chip>
                                                    <mat-chip class="location-chip">
                                                        <mat-icon>place</mat-icon>
                                                        {{aplicacion.offer.location}}
                                                    </mat-chip>
                                                    <mat-chip class="payment-chip" *ngIf="aplicacion.offer.estimatedPayment">
                                                        <mat-icon>payments</mat-icon>
                                                        {{aplicacion.offer.estimatedPayment}}
                                                    </mat-chip>
                                                </mat-chip-set>
                                            </div>
                                        </div>

                                        <!-- Offer Description -->
                                        <div class="offer-content">
                                            <div class="offer-description">
                                                <p class="description-text">{{aplicacion.offer.description}}</p>
                                                <button mat-button class="expand-btn" *ngIf="isDescriptionLong(aplicacion.offer.description)">
                                                    <mat-icon>expand_more</mat-icon>
                                                    Ver más
                                                </button>
                                            </div>

                                            <!-- Tags/Skills si están disponibles -->
                                            <!-- <div class="offer-tags" *ngIf="aplicacion.offer.tags && aplicacion.offer.tags.length">
                                                <h6>Tecnologías requeridas:</h6>
                                                <mat-chip-set class="skills-chips">
                                                    <mat-chip *ngFor="let tag of aplicacion.offer.tags" class="skill-tag">
                                                        {{tag}}
                                                    </mat-chip>
                                                </mat-chip-set>
                                            </div> -->
                                        </div>

                                        <!-- Custom Cover Letter -->
                                        <div class="cover-letter-section" *ngIf="aplicacion.customCoverLetter">
                                            <div class="cover-letter-header">
                                                <mat-icon class="letter-icon">mail_outline</mat-icon>
                                                <span class="letter-title">Tu carta de presentación</span>
                                                <button mat-icon-button class="toggle-letter" (click)="toggleCoverLetter(aplicacion.id)">
                                                    <mat-icon>{{isCoverLetterExpanded(aplicacion.id) ? 'expand_less' : 'expand_more'}}</mat-icon>
                                                </button>
                                            </div>
                                            <div class="cover-letter-content"
                                                 [class.expanded]="isCoverLetterExpanded(aplicacion.id)"
                                                 *ngIf="isCoverLetterExpanded(aplicacion.id)">
                                                <p class="cover-letter-text">{{aplicacion.customCoverLetter}}</p>
                                            </div>
                                        </div>

                                        <!-- Timeline/Dates -->
                                        <div class="application-timeline" *ngIf="hasTimelineData(aplicacion)">
                                            <div class="timeline-item">
                                                <mat-icon class="timeline-icon">send</mat-icon>
                                                <span>Aplicación enviada: {{aplicacion.applicationDate | date:'dd/MM/yyyy'}}</span>
                                            </div>
                                            <div class="timeline-item" *ngIf="aplicacion.offer.expirationDate">
                                                <mat-icon class="timeline-icon">schedule</mat-icon>
                                                <span>Fecha límite: {{aplicacion.offer.expirationDate | date:'dd/MM/yyyy'}}</span>
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="offer-actions">
                                            <button mat-flat-button color="primary" (click)="verDetalleOferta(aplicacion.offer.id)">
                                                <mat-icon>visibility</mat-icon>
                                                Ver Detalle
                                            </button>
                                            <button mat-stroked-button color="warn" (click)="retirarAplicacion(aplicacion.id)"
                                                    *ngIf="canWithdrawApplication(aplicacion.status)">
                                                <mat-icon>cancel</mat-icon>
                                                Cancelar Aplicación
                                            </button>
                                        </div>
                                    </ng-container>

                                    <!-- Fallback para cuando la oferta no existe o fue eliminada -->
                                    <ng-container *ngIf="!aplicacion.offer">
                                        <div class="offer-header">
                                            <h4 class="offer-title error-title">Oferta no disponible</h4>
                                            <div class="offer-details">
                                                <span class="offer-error">
                                                    <mat-icon>error_outline</mat-icon>
                                                    Esta oferta ya no está disponible o fue eliminada
                                                </span>
                                            </div>
                                        </div>

                                        <div class="cover-letter" *ngIf="aplicacion.customCoverLetter">
                                            <div class="cover-letter-header">
                                                <mat-icon>mail</mat-icon>
                                                <span>Tu carta de presentación:</span>
                                            </div>
                                            <p class="cover-letter-text">{{aplicacion.customCoverLetter}}</p>
                                        </div>

                                        <mat-divider></mat-divider>
                                    </ng-container>
                                </div>
                            </div>                            <ng-template #emptyOffers>
                                <div class="offers-empty">
                                    <mat-icon>work_off</mat-icon>
                                    <h4>No has aplicado a ninguna oferta aún</h4>
                                    <p>Explora las ofertas disponibles y comienza a aplicar a las que más te interesen.</p>
                                </div>
                            </ng-template>
                        </ng-container>
                    </mat-card-content>
                </mat-card>

                <!-- 9. Ofertas Publicadas - solo para perfil propio (grid-area: my-offers) -->
                <mat-card class="modern-card published-offers-card" *ngIf="isOwnProfile()">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">post_add</mat-icon>
                            Mis Publicaciones
                            <span class="applications-count" *ngIf="totalOfertasPublicadas > 0">({{totalOfertasPublicadas}})</span>
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <!-- Loading state -->
                        <div class="ofertas-loading" *ngIf="isOfertasPublicadasLoading">
                            <div class="loading-spinner"></div>
                            <p>Cargando publicaciones...</p>
                        </div>

                        <!-- Error state -->
                        <div class="ofertas-error" *ngIf="ofertasPublicadasError && !isOfertasPublicadasLoading">
                            <mat-icon>error_outline</mat-icon>
                            <span>{{ofertasPublicadasError}}</span>
                        </div>

                        <!-- Content -->
                        <ng-container *ngIf="!isOfertasPublicadasLoading && !ofertasPublicadasError">
                            <div class="applied-offers-list" *ngIf="ofertasPublicadas.length; else emptyPublishedOffers">
                                <div class="offer-card" *ngFor="let oferta of ofertasPublicadas; trackBy: trackByOfertaPublicada">
                                    <!-- Offer Header -->
                                    <div class="offer-header">
                                        <div class="offer-title-section">
                                            <h4 class="offer-title">{{oferta.title}}</h4>
                                            <div class="offer-meta">
                                                <span class="publication-badge">
                                                    <mat-icon>verified</mat-icon>
                                                    Publicada
                                                </span>
                                            </div>
                                        </div>

                                        <!-- Quick Info Pills -->
                                        <div class="offer-pills">
                                            <mat-chip-set class="info-chips">
                                                <mat-chip class="modality-chip" [class]="getModalityClass(oferta.modality)">
                                                    <mat-icon>{{getModalityIcon(oferta.modality)}}</mat-icon>
                                                    {{getModalityText(oferta.modality)}}
                                                </mat-chip>
                                                <mat-chip class="location-chip">
                                                    <mat-icon>place</mat-icon>
                                                    {{oferta.location}}
                                                </mat-chip>
                                                <mat-chip class="payment-chip" *ngIf="oferta.estimatedPayment">
                                                    <mat-icon>payments</mat-icon>
                                                    {{oferta.estimatedPayment}}
                                                </mat-chip>
                                            </mat-chip-set>
                                        </div>
                                    </div>

                                    <!-- Offer Content -->
                                    <div class="offer-content">
                                        <div class="offer-description">
                                            <p class="description-text">{{oferta.description}}</p>
                                        </div>

                                        <!-- Requirements section -->
                                        <div class="offer-requirements" *ngIf="oferta.requirements">
                                            <h6><mat-icon>assignment</mat-icon> Requisitos:</h6>
                                            <p>{{oferta.requirements}}</p>
                                        </div>

                                        <!-- Skills/Attributes -->
                                        <div class="offer-tags" *ngIf="oferta.attributes && oferta.attributes.length">
                                            <h6><mat-icon>code</mat-icon> Tecnologías requeridas:</h6>
                                            <mat-chip-set class="skills-chips">
                                                <mat-chip *ngFor="let attr of oferta.attributes" class="skill-tag">
                                                    {{attr}}
                                                </mat-chip>
                                            </mat-chip-set>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="offer-actions">
                                        <button mat-flat-button color="primary" (click)="verDetalleOferta(oferta.id)">
                                            <mat-icon>visibility</mat-icon>
                                            Ver Detalle
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Empty state -->
                            <ng-template #emptyPublishedOffers>
                                <div class="offers-empty-state">
                                    <mat-icon>post_add</mat-icon>
                                    <h4>No has publicado ofertas aún</h4>
                                    <p>Cuando publiques una oferta laboral, aparecerá aquí para que puedas gestionarla y editarla.</p>
                                </div>
                            </ng-template>
                        </ng-container>
                    </mat-card-content>
                </mat-card>

                <!-- 10. Materias Aprobadas - Al final ocupando todo el ancho (grid-area: materias) -->
                <mat-card class="modern-card subjects-card">
                    <mat-card-header>
                        <mat-card-title class="section-title">
                            <mat-icon class="section-icon">library_books</mat-icon>
                            Materias Aprobadas
                        </mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                        <div class="subjects-summary" *ngIf="materiasAlumno().length">
                            <div class="summary-item">
                                <span class="summary-label">Materias cargadas</span>
                                <span class="summary-value">{{totalMaterias()}}</span>
                             </div>
                            <div class="summary-item">
                                <span class="summary-label">Promedio general</span>
                                <span class="summary-value">{{promedioMaterias() | number:'1.2-2'}}</span>
                            </div>
                        </div>

                        <!-- Solo mostrar opción de subir materias si es el perfil propio -->
                        <div class="subjects-upload" *ngIf="isOwnProfile()">
                            <div class="upload-info">
                                <mat-icon>upload_file</mat-icon>
                                <div>
                                    <h4>Planilla de materias</h4>
                                    <p>Formato permitido: .xls o .xlsx (Alumnos Web)</p>
                                </div>
                            </div>
                            <div class="upload-actions">
                                <input type="file" #materiasInput accept=".xls , .xlsx"
                                    (change)="onMateriasFileSelected($event)" hidden>
                                <button mat-stroked-button class="upload-btn" (click)="materiasInput.click()"
                                    [disabled]="isMateriasUploading">
                                    <mat-icon *ngIf="!isMateriasUploading">cloud_upload</mat-icon>
                                    <mat-icon *ngIf="isMateriasUploading" class="spin">autorenew</mat-icon>
                                    {{isMateriasUploading ? 'Subiendo...' : 'Subir .xls o .xlsx'}}
                                </button>
                            </div>
                        </div>

                        <div class="file-processing" *ngIf="selectedMateriasFileName && isMateriasUploading">
                            Procesando {{selectedMateriasFileName}}...
                        </div>

                        <div class="subjects-error" *ngIf="materiasError">
                            <mat-icon>error_outline</mat-icon>
                            <span>{{materiasError}}</span>
                        </div>

                        <div class="subjects-table" *ngIf="materiasAlumno().length; else emptySubjects">
                            <div class="table-header">
                                <span>Materia</span>
                                <span>Código</span>
                                <span>Nota</span>
                            </div>
                            <div class="table-row" *ngFor="let materia of materiasAlumno(); trackBy: trackByMateria">
                                <div class="materia-name">
                                    <span class="materia-title">{{materia.name}}</span>
                                </div>
                                <span class="materia-code">{{materia.code}}</span>
                                <span class="materia-grade">{{materia.note | number:'1.0-1'}}</span>
                            </div>
                        </div>
                        <ng-template #emptySubjects>
                            <div class="subjects-empty">
                                <mat-icon>inventory_2</mat-icon>
                                <p *ngIf="isOwnProfile()">
                                    Subí tu .xls o .xlsx de Alumnos Web para visualizar tus materias aprobadas.
                                </p>
                                <p *ngIf="!isOwnProfile()">
                                    Este usuario no tiene materias cargadas actualmente.
                                </p>
                            </div>
                        </ng-template>
                    </mat-card-content>
                </mat-card>
            </div>
        </div>
    </div>
</div>
